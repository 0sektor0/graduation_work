function [y1,xf1] = NAR(x1,xi1)
%MYNEURALNETWORKFUNCTION neural network simulation function.
%
% Generated by Neural Network Toolbox function genFunction, 20-May-2018 21:59:15.
%
% [y1,xf1] = myNeuralNetworkFunction(x1,xi1) takes these arguments:
%   x1 = 1xTS matrix, input #1
%   xi1 = 1x20 matrix, initial 20 delay states for input #1.
% and returns:
%   y1 = 1xTS matrix, output #1
%   xf1 = 1x20 matrix, final 20 delay states for input #1.
% where TS is the number of timesteps.

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1.xoffset = 0.571476510067114;
x1_step1.gain = 4.66718872357087;
x1_step1.ymin = -1;

% Layer 1
b1 = [-1.5815037635530437843;1.1792108349164323045;0.81894417692881393833;-0.6949846873958868132;0.041305378874869312644;0.031707810924431971411;0.29415154240615121184;-1.1902247063617534817;1.2549606847524259479;1.6711363222237958226];
IW1_1 = [0.38496481608729704593 -0.49159139916755117961 -0.37453248503727248897 0.29183904719589542909 -0.1512415148313680513 0.1233104728555749624 0.39694808467375947147 -0.026174841107254570582 0.35950043949788879072 -0.49401028653110384825 -0.47585211971181201607 -0.48772421901279983114 0.38732320432182792969 -0.16068212565474340736 0.32994359668990685952 0.4264964363619276333 -0.2413411268466899573 -0.45987896104507036688 0.15920315685334845979 0.2322803183025454743;-0.071990556268772001869 0.61329163864930302807 -0.22387692308451589973 -0.0047159147543545309675 0.089493188822612951272 0.50531878979918976036 -0.47877065502624216453 -0.29707356632632170301 -0.19453833908663561991 -0.27513530737516578295 0.1842113048444131429 -0.095418672932325893088 -0.35211676666894237142 0.014352088433590938152 -0.46938158181376821165 0.16250031073690388017 -0.67300444301826845006 -0.10983356416260094124 -0.4727297805781321971 0.41562710673723823884;-0.39157266954328046049 -0.42045255489714167263 0.49778958945031820393 0.48892228011268923371 0.02974187259518668025 0.28831264651656224318 0.35456305873200294476 0.24847144412905947108 0.31950712429145688986 0.42381616756080819908 -0.34868817756854386669 0.33049023284650563825 -0.28721980530711199719 0.14100077730924021058 0.45451780143408548884 -0.10270160829180942363 -0.46688625737511657565 0.42768948566846692882 0.32170560619722904372 0.036453226190822647645;0.46248539900606022712 0.11524128179269250982 0.21138174892061092902 -0.0095934534198605977279 -0.12195742439814442892 0.29229015405669744876 -0.22735907566167909422 0.032968488856793286279 0.27236991343055633186 0.067791261067658814543 0.26522940227218150255 -0.11539677111976108514 0.077680053854057642959 -0.011217862081400260116 -0.30888225924042450599 -0.30722551898012512295 0.040199443734052466015 -0.0049994072073883061638 0.0038732984196114626091 0.039678911832003865845;0.59763926471835560061 -0.10188959382902876283 0.094515265039055454399 -0.43521549009466320435 0.24023250839970541892 0.68294247172741018304 0.16558727104176687583 0.51867026911905123043 0.38196073286068688013 -0.017197876302065411708 0.31923896341230412199 -0.023324062050838405974 0.17949616454280695188 0.13183545339323538004 0.083052676992385277011 0.35347443829109875812 -0.54651112242529498175 -0.22987954865523410608 0.070471216667265260125 0.35748441467098851509;-0.82558606843241255646 -0.27941120153979742691 0.28126523771929884399 0.072213016865441001513 -0.17883204285053161398 0.21974295844695598823 -0.15019053109356192421 0.093054363779677129465 0.27832511243951835178 0.14217292471756046157 0.13441659050003276765 -0.053390250605817049512 0.12110987107250142936 -0.080842811380292478596 -0.28061589370625350526 -0.21784985277367024947 0.070980405921030442773 0.00087718239614363244239 -0.11178680030600730844 0.18693568942634769536;0.41708237961372751634 0.34656414753299358278 0.047355353139681789776 0.37152227866398779277 0.37012053041598191871 0.40659638562537053774 0.36583920671675407288 0.049107126779086032742 -0.12010882980047621338 -0.25333190679189332428 -0.065506835686398812157 0.44354673118390258724 0.35096380359557460826 0.51079573920439824697 -0.1760711728632797235 0.24929331604308108128 0.2638592339279536847 0.39677868810502520125 -0.46245711122430993578 -0.027723585604883103917;-1.018754688930471497 0.039497652730179466651 0.0085302372664621973347 -0.13621659567119012713 0.18517399211224316868 -0.15301155869805638243 0.28299137907895410837 -0.21784112176225275959 -0.31302081802079495532 -0.16041511832831448214 -0.32732103668345047254 0.035111544410071277023 -0.095270266856283730705 0.18063624905307471002 0.26053871861686755951 0.17804312190443835617 0.10534905837650267169 -0.27766825263852290551 0.32228098105913438598 -0.058110101717214562855;0.14987359348963597006 0.19201243522314628831 0.39577492214382398172 -0.28732586977364360514 -0.064910764417135002891 0.43810686440975132872 -0.49621625409811104257 -0.19426782944924445018 0.26435093432805401026 0.11661503447307162984 -0.078212952766625501444 0.30621269132814354919 -0.20625715185167967092 0.42229085089753704008 0.4157909209722539523 0.19114843237316916924 -0.47589519240273525647 -0.42521497696553112178 -0.47948895426355109262 0.51150173424374179021;0.24421179077489871267 -0.44105658227654248593 0.46446965101165044176 0.15605409990799695708 -0.16756707626175978976 -0.18695644771118857808 0.43196212911919956712 0.32924191291540155779 -0.17961320286086637776 -0.36214019913955758367 -0.3524730085862461948 -0.42100341506287786153 0.34460793849929766131 -0.22809866971473144459 -0.30120833829074883381 -0.29815818744044986222 0.54445622071653221319 0.42600758785386044769 0.35874641175008920024 0.085712322733720827661];

% Layer 2
b2 = -0.55740464087370500401;
LW2_1 = [0.035356921984950960558 -0.052699149179801146881 0.012473791981407109791 0.691759326901228766 -0.005587473450520845375 -0.63233507590818427424 0.017596554571229976877 -0.37600910428588324441 0.19915603357736313961 0.61712559770214581167];

% Output 1
y1_step1.ymin = -1;
y1_step1.gain = 4.66718872357087;
y1_step1.xoffset = 0.571476510067114;

% ===== SIMULATION ========

% Dimensions
TS = size(x1,2); % timesteps

% Input 1 Delay States
xd1 = mapminmax_apply(xi1,x1_step1);
xd1 = [xd1 zeros(1,1)];

% Allocate Outputs
y1 = zeros(1,TS);

% Time loop
for ts=1:TS
    
    % Rotating delay state position
    xdts = mod(ts+19,21)+1;
    
    % Input 1
    xd1(:,xdts) = mapminmax_apply(x1(:,ts),x1_step1);
    
    % Layer 1
    tapdelay1 = reshape(xd1(:,mod(xdts-[1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20]-1,21)+1),20,1);
    a1 = tansig_apply(b1 + IW1_1*tapdelay1);
    
    % Layer 2
    a2 = b2 + LW2_1*a1;
    
    % Output 1
    y1(:,ts) = mapminmax_reverse(a2,y1_step1);
end

% Final delay states
finalxts = TS+(1: 20);
xits = finalxts(finalxts<=20);
xts = finalxts(finalxts>20)-20;
xf1 = [xi1(:,xits) x1(:,xts)];
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings)
y = bsxfun(@minus,x,settings.xoffset);
y = bsxfun(@times,y,settings.gain);
y = bsxfun(@plus,y,settings.ymin);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n,~)
a = 2 ./ (1 + exp(-2*n)) - 1;
end

% Map Minimum and Maximum Output Reverse-Processing Function
function x = mapminmax_reverse(y,settings)
x = bsxfun(@minus,y,settings.ymin);
x = bsxfun(@rdivide,x,settings.gain);
x = bsxfun(@plus,x,settings.xoffset);
end
