function [y1,xf1,xf2] = SimulateNarxNetwork(x1,x2,xi1,xi2)
%MYNEURALNETWORKFUNCTION neural network simulation function.
%
% Generated by Neural Network Toolbox function genFunction, 15-Apr-2018 18:58:38.
%
% [y1,xf1,xf2] = myNeuralNetworkFunction(x1,x2,xi1,xi2) takes these arguments:
%   x1 = 1xTS matrix, input #1
%   x2 = 1xTS matrix, input #2
%   xi1 = 1x5 matrix, initial 5 delay states for input #1.
%   xi2 = 1x5 matrix, initial 5 delay states for input #2.
% and returns:
%   y1 = 1xTS matrix, output #1
%   xf1 = 1x5 matrix, final 5 delay states for input #1.
%   xf2 = 1x5 matrix, final 5 delay states for input #2.
% where TS is the number of timesteps.

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1.xoffset = 510.9;
x1_step1.gain = 0.00522056904202558;
x1_step1.ymin = -1;

% Input 2
x2_step1.xoffset = 510.9;
x2_step1.gain = 0.00522056904202558;
x2_step1.ymin = -1;

% Layer 1
b1 = [4.9773431939802169116e-05;9.8878988238197689534e-06;0.55263499084322531552;-0.00037460151741948709845;-0.0017792644490933061819;-0.00040994366780857576047;-0.00033476677948276919701;0.0023760813238824676601;-5.0707542160442179054e-05;1.8734677549194068106e-05;4.7094002771334811006e-05;0.0017744640474901310877;8.4464370938618264588e-05;3.8305031016726960819e-05;-3.2205449709688610484e-05;0.00085814413440227666364;-0.00017734700689431143737;-8.9593666368782955644e-05;4.6329875513600856849e-05;6.8787068241950993785e-05;5.6491704254643376867e-05;-0.0010449646878335050026;-3.8555215100393103655e-05;0.00076804746711262592354;-7.7795584461032681522e-05;-0.0001748938974409365544;0.00016166958205091023636;-0.00049371601760980884845;-4.2717700514878889954e-05;0.0002431846808492269267;-2.8933289297403557051e-05;0.00042103433238480330973;5.7895232107972748503e-05;-1.1507114614677088683e-05;-0.00028029293549536316021;0.00038797513083876537061;4.8834958309353008034e-05;0.00057221884578159167012;-0.0010841226100788275977;0.00034227969671818435967;8.9462841346444273746e-05;-8.3684773266832137716e-05;-1.6988997032320921857e-05;-6.390573429040299631e-05;0.00010850132504732770081;-7.7859269240549168196e-05;0.00013632329784722845077;-0.00012895869574362138705;0.00074049413706919926803;-0.0039047960121330817403];
IW1_1 = [0.008014349959119570696 -0.051646346354639140197 0.0035576770568487583145 0.002210314212105949673 -0.018012500681956852833;0.0080374855297292296941 -0.051656314884466258963 0.0035482879874866491039 0.00221282045664108638 -0.018023833243439896235;0.20687721659579796918 -0.65487787446417045079 0.035757232922537685038 0.033545849140169760327 -0.25839618410312592545;0.0082603959113345132997 -0.051752700988356263589 0.003457916396912625711 0.0022371152625066783107 -0.018132974037110692611;0.0090730097775690004419 -0.052109205862619779881 0.0031297827009332214107 0.002327864507854333475 -0.018530162112849996037;0.0082808667250315413227 -0.051761597534639193496 0.0034496101182185457193 0.0022393495546298982854 -0.018143009001349488102;0.0082373139161929578855 -0.051742686785584517117 0.0034672717348996641949 0.0022345906941716587972 -0.018121671044429622094;-0.0094174802917548015163 0.052262634185900443129 -0.0029913316554461516321 -0.0023673753000457253663 0.018698154533813085565;0.0080726279815382835647 -0.051671471798627709171 0.003534026554400985197 0.0022166309497416367136 -0.018041048408579205692;-0.0080540865475455386546 0.051663472128027833341 -0.0035415516972776249494 -0.0022146204468765570694 0.018031964628194396827;0.0080159042322940059905 -0.051647015837677098804 0.0035570462390248831254 0.0022104824981974357211 -0.018013262038669458631;-0.0090702017330500390307 0.052108025979371683234 -0.0031308535081222147248 -0.002327504857079117518 0.018528859162311079462;-0.0080922058113929891399 0.0516799188943565177 -0.0035260882212662658652 -0.0022187597685770802866 0.01805063320044989969;0.0080210023742043924655 -0.051649212082849366157 0.0035549770479550105856 0.0022110345095581306757 -0.018015759431209209945;-0.0080245397661934426969 0.051650736912471365003 -0.0035535401045978104451 -0.0022114168191326912666 0.018017493435801244794;-0.0085404209520300849307 0.05187468615854373688 -0.0033445806497249047293 -0.0022679822054459540699 0.018270000903370019196;0.0081460613781640413278 -0.051703186773440538981 0.0035042483380754167917 0.0022246204618097181402 -0.01807700528668809356;0.0080951801506382557727 -0.051681203081888733852 0.0035248816890292009908 0.0022190829699422669544 -0.018052089919474222784;0.0080163473885141462577 -0.051647206837684971059 0.0035568662062616623713 0.0022105303728672167501 -0.018013479283775474249;0.0080033202479211796448 -0.051641596390131300209 0.0035621536846484271217 0.0022091202843324696421 -0.018007097805499552162;0.0080104522870428507969 -0.051644668169568253013 0.0035592580241844327081 0.0022098916482743286016 -0.018010592308764752228;0.0086485265700775165731 -0.051922030552677828075 0.0033008969199636202518 0.0022800105574125608364 -0.018322861883720457238;0.0080655804252281713962 -0.051668431178105989066 0.0035368858800150400346 0.0022158660230415135051 -0.018037596552484342488;-0.0084882682620184626843 0.051851896759477961174 -0.003365667632763179231 -0.0022622010073404621479 0.018244492766525257504;0.0080883383512539638871 -0.051678249778775824097 0.003527656451985936633 0.0022183391766951851207 -0.018048739695616020789;0.0081446358483502519221 -0.051702575200638839492 0.0035048203938120971526 0.0022244613123325552781 -0.018076313349283328058;-0.0081369719987026585539 0.051699257362843024921 -0.0035079335262626575552 -0.0022236301640297566687 0.018072554865186874623;0.0083294119854368173228 -0.051782667411007857194 0.003429969252553487398 0.002244690882075785817 -0.018166748101169492846;0.0080679958979497992666 -0.051669471376623442305 0.0035359085733695852505 0.0022161298837235230211 -0.018038776993958713368;-0.008184228696316617202 0.051719697966581830439 -0.0034887767728541893564 -0.0022287836284472744945 0.018095691572303208849;-0.0080264385216516822424 0.051651554199215320151 -0.0035527709160374735392 -0.0022116233675182179162 0.018018422206640197225;-0.0082872927604015766967 0.051764387350364815532 -0.0034470072707251317445 -0.0022400542216221446847 0.018146154342332052739;0.0080096386041087971885 -0.05164431721947247006 0.0035595892002480999418 0.0022098041416167934874 -0.018010192866566666903;0.0080498935722541613974 -0.051661665419518505715 0.0035432509548869112539 0.0022141643782042758591 -0.0180299128885263657;0.0082057330016365361697 -0.051729016964038601611 0.0034800523735822237216 0.0022311264650155216913 -0.018106228701101619721;-0.0082681374324832784123 0.051756072727884142037 -0.0034547664552332306258 -0.0022379543133948165065 0.018136778233986607101;0.0080148937462029955919 -0.051646581233617143425 0.0035574552240163746265 0.002210372385111666893 -0.018012768110887124318;-0.0083748868684435061327 0.051802443645454193666 -0.0034115637382138110957 -0.0022496965642909176261 0.018188996902453784255;0.0086712094566717707461 -0.051931927451250879668 0.0032917858383524206678 0.0022825758741641718336 -0.018333893967460650198;-0.0082416697420246726874 0.051744571946212368496 -0.0034655101270019052911 -0.0022350695609668581529 0.018123799681408842011;0.007991325862054119572 -0.05163643260822897707 0.0035670224767645440644 0.0022078227828656545907 -0.018001221986687670346;-0.0079946777789269667103 0.051637875586650776316 -0.0035656616124813437715 -0.0022081851794835734987 0.018002864231351129592;0.0080530742145605294091 -0.051663035413709458565 0.0035419626770157651256 0.0022145107850222544958 -0.018031468563456960058;-0.0080061519552332462146 0.05164281569979751324 -0.0035610043849623575565 -0.0022094267716320035305 0.018008484889311875826;0.0079802809215544431853 -0.05163167903181249685 0.0035715065798121747344 0.0022066288484634505145 -0.017995810807476742693;-0.0079980573857324037401 0.051639330407442646242 -0.0035642899607422370671 -0.0022085508878828242173 0.018004519641744442388;-0.0081222735255065958704 0.051692908906849827089 -0.0035138887411395479041 -0.002222026663991515192 0.018065362519958872572;0.008118006198089052633 -0.051691061214908622101 0.0035156243181426747105 0.0022215655263553178364 -0.018063267748112774025;-0.0084723362244689855161 0.051844907327905635774 -0.0033721443773682339799 -0.0022604599547937568975 0.018236662601351545654;0.01029588869088010443 -0.05266285480147253617 0.0026368379396465363093 0.0024688050481325115627 -0.019128886587093225924];
IW1_2 = [-0.022217893943783113136 0.008014349959119570696 -0.051646346354639140197 0.0035576770568487583145 0.0022103142121059492393;-0.022223369056659409565 0.0080374855297292296941 -0.051656314884466258963 0.0035482879874866495376 0.00221282045664108638;1.0485875213534525674 0.20687721659579796918 -0.65487787446417045079 0.035757232922537685038 0.033545849140169760327;-0.022276219692836409653 0.0082603959113345132997 -0.051752700988356263589 0.003457916396912625711 0.0022371152625066783107;-0.022470396833076267812 0.0090730097775690004419 -0.052109205862619779881 0.0031297827009332214107 0.0023278645078543330413;-0.02228109521318702782 0.008280866725031539588 -0.051761597534639193496 0.0034496101182185457193 0.0022393495546298982854;-0.022270734342661677174 0.0082373139161929578855 -0.051742686785584517117 0.0034672717348996641949 0.0022345906941716587972;0.022553358572993273401 -0.0094174802917548015163 0.052262634185900443129 -0.0029913316554461520658 -0.0023673753000457253663;-0.022231691738036761519 0.0080726279815382835647 -0.051671471798627709171 0.003534026554400985197 0.0022166309497416367136;0.022227299121703538581 -0.0080540865475455386546 0.051663472128027833341 -0.0035415516972776249494 -0.0022146204468765570694;-0.022218261702126863161 0.0080159042322940059905 -0.051647015837677098804 0.0035570462390248826917 0.0022104824981974357211;0.022469776156507650922 -0.0090702017330500390307 0.052108025979371683234 -0.0031308535081222147248 -0.002327504857079117518;0.022236326372495278381 -0.0080922058113929908746 0.0516799188943565177 -0.0035260882212662658652 -0.0022187597685770802866;-0.022219468128884492519 0.0080210023742043907308 -0.051649212082849366157 0.0035549770479550105856 0.0022110345095581311094;0.022220306223504508736 -0.0080245397661934409622 0.051650736912471365003 -0.0035535401045978104451 -0.0022114168191326908329;0.022342896713544981024 -0.0085404209520300831959 0.05187468615854373688 -0.0033445806497249047293 -0.0022679822054459540699;-0.022249090003993516468 0.0081460613781640413278 -0.051703186773440538981 0.0035042483380754167917 0.0022246204618097181402;-0.022237031097872866914 0.0080951801506382557727 -0.051681203081888733852 0.0035248816890292014245 0.0022190829699422669544;-0.022218366692613854968 0.0080163473885141479924 -0.051647206837684971059 0.0035568662062616623713 0.0022105303728672163165;-0.022215284536341431409 0.0080033202479211813796 -0.051641596390131300209 0.0035621536846484271217 0.0022091202843324696421;-0.022216972473111166325 0.0080104522870428507969 -0.051644668169568253013 0.0035592580241844327081 0.0022098916482743286016;-0.022368708917768473365 0.0086485265700775165731 -0.051922030552677828075 0.0033008969199636202518 0.0022800105574125608364;-0.022230022604388922913 0.0080655804252281713962 -0.051668431178105989066 0.0035368858800150400346 0.0022158660230415135051;0.022330459215735211365 -0.0084882682620184626843 0.051851896759477961174 -0.003365667632763179231 -0.0022622010073404621479;-0.022235410604775161098 0.0080883383512539638871 -0.051678249778775824097 0.003527656451985936633 0.0022183391766951851207;-0.02224875685666274916 0.0081446358483502519221 -0.051702575200638839492 0.0035048203938120971526 0.0022244613123325552781;0.022246935217399232965 -0.0081369719987026585539 0.051699257362843024921 -0.0035079335262626575552 -0.0022236301640297566687;-0.022292618927112026195 0.0083294119854368173228 -0.051782667411007857194 0.003429969252553487398 0.002244690882075785817;-0.022230592545740991001 0.0080679958979497992666 -0.051669471376623442305 0.0035359085733695852505 0.0022161298837235230211;0.022258141446986807327 -0.008184228696316617202 0.051719697966581830439 -0.0034887767728541893564 -0.0022287836284472744945;0.022220754530123617426 -0.0080264385216516822424 0.051651554199215320151 -0.0035527709160374735392 -0.0022116233675182179162;0.022282622322014621757 -0.0082872927604015766967 0.051764387350364815532 -0.0034470072707251317445 -0.0022400542216221446847;-0.022216779281789993117 0.0080096386041087971885 -0.05164431721947247006 0.0035595892002480999418 0.0022098041416167934874;-0.022226307980832242517 0.0080498935722541613974 -0.051661665419518505715 0.0035432509548869112539 0.0022141643782042758591;-0.022263251494256605656 0.0082057330016365361697 -0.051729016964038601611 0.0034800523735822237216 0.0022311264650155216913;0.022278070629590293605 -0.0082681374324832784123 0.051756072727884142037 -0.0034547664552332306258 -0.0022379543133948165065;-0.022218023449015009141 0.0080148937462029955919 -0.051646581233617143425 0.0035574552240163746265 0.002210372385111666893;0.022303433225071469387 -0.0083748868684435061327 0.051802443645454193666 -0.0034115637382138110957 -0.0022496965642909176261;-0.022374084573168133427 0.0086712094566717707461 -0.051931927451250879668 0.0032917858383524206678 0.0022825758741641718336;0.022271765797186114655 -0.0082416697420246726874 0.051744571946212368496 -0.0034655101270019052911 -0.0022350695609668581529;-0.022212447279226648494 0.007991325862054119572 -0.051636432608228970131 0.0035670224767645440644 0.0022078227828656545907;0.022213240261827218308 -0.0079946777789269667103 0.051637875586650776316 -0.0035656616124813437715 -0.0022081851794835734987;-0.022227059257729268882 0.0080530742145605294091 -0.051663035413709458565 0.0035419626770157651256 0.0022145107850222544958;0.022215954386849416646 -0.0080061519552332462146 0.05164281569979751324 -0.0035610043849623575565 -0.0022094267716320035305;-0.022209834870428695613 0.0079802809215544414506 -0.05163167903181249685 0.0035715065798121747344 0.0022066288484634505145;0.022214039533331456783 -0.0079980573857324037401 0.051639330407442646242 -0.0035642899607422370671 -0.0022085508878828242173;0.02224345512289829449 -0.0081222735255065958704 0.051692908906849827089 -0.0035138887411395479041 -0.002222026663991515192;-0.02224243965361823866 0.008118006198089052633 -0.051691061214908622101 0.0035156243181426747105 0.0022215655263553178364;0.022326632146968294207 -0.0084723362244689855161 0.051844907327905635774 -0.0033721443773682339799 -0.0022604599547937568975;-0.022769285306832285493 0.01029588869088010443 -0.05266285480147253617 0.002636837939646536743 0.0024688050481325115627];

% Layer 2
b2 = -0.44943434901025985928;
LW2_1 = [-0.17225324651387730057 -0.17226282383466029469 0.88788966813773562148 -0.17235608859411399862 -0.17271101319872342317 -0.17236474616803579285 -0.17234634692669290046 0.17286838257457215473 -0.17227740846362885052 0.17226970799848204119 -0.17225388932269039555 0.17270977130037681868 0.17228555305636408801 -0.17225599839049277051 0.17225746213521858641 0.17247577863183416458 -0.17230802855227905779 -0.1722867916178822123 -0.17225407259674146987 -0.17224868738578605343 -0.17225163472895713146 -0.17252272884361918859 -0.17227447999172690318 0.17245327642933816481 -0.17228394311209926926 -0.17230743273900472889 0.1723042279828441159 -0.17238532566096126386 -0.17227548364444789097 0.17232401996232843411 0.17225824834022182563 0.17236746610249006895 -0.17225129853946913316 -0.17226796810102973367 -0.17233305432514267608 0.17235936263378659472 -0.17225347119794615081 0.17240468269410125224 -0.17253261241195652631 0.17234818252187952825 -0.17224373452906360793 0.17224511806945697057 -0.17226928791764611892 0.17224985745981513663 -0.17223917841424379871 0.17224651354832670735 0.17229808854032310772 -0.17229630726695113752 0.17244641085033104999 -0.17328870109899624508];

% Output 1
y1_step1.ymin = -1;
y1_step1.gain = 0.00522056904202558;
y1_step1.xoffset = 510.9;

% ===== SIMULATION ========

% Dimensions
TS = size(x1,2); % timesteps

% Input 1 Delay States
xd1 = mapminmax_apply(xi1,x1_step1);
xd1 = [xd1 zeros(1,1)];

% Input 2 Delay States
xd2 = mapminmax_apply(xi2,x2_step1);
xd2 = [xd2 zeros(1,1)];

% Allocate Outputs
y1 = zeros(1,TS);

% Time loop
for ts=1:TS
    
    % Rotating delay state position
    xdts = mod(ts+4,6)+1;
    
    % Input 1
    xd1(:,xdts) = mapminmax_apply(x1(:,ts),x1_step1);
    
    % Input 2
    xd2(:,xdts) = mapminmax_apply(x2(:,ts),x2_step1);
    
    % Layer 1
    tapdelay1 = reshape(xd1(:,mod(xdts-[1 2 3 4 5]-1,6)+1),5,1);
    tapdelay2 = reshape(xd2(:,mod(xdts-[1 2 3 4 5]-1,6)+1),5,1);
    a1 = tansig_apply(b1 + IW1_1*tapdelay1 + IW1_2*tapdelay2);
    
    % Layer 2
    a2 = b2 + LW2_1*a1;
    
    % Output 1
    y1(:,ts) = mapminmax_reverse(a2,y1_step1);
end

% Final delay states
finalxts = TS+(1: 5);
xits = finalxts(finalxts<=5);
xts = finalxts(finalxts>5)-5;
xf1 = [xi1(:,xits) x1(:,xts)];
xf2 = [xi2(:,xits) x2(:,xts)];
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings)
y = bsxfun(@minus,x,settings.xoffset);
y = bsxfun(@times,y,settings.gain);
y = bsxfun(@plus,y,settings.ymin);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n,~)
a = 2 ./ (1 + exp(-2*n)) - 1;
end

% Map Minimum and Maximum Output Reverse-Processing Function
function x = mapminmax_reverse(y,settings)
x = bsxfun(@minus,y,settings.ymin);
x = bsxfun(@rdivide,x,settings.gain);
x = bsxfun(@plus,x,settings.xoffset);
end
